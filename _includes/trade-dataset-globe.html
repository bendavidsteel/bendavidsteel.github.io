<head>
    <style> body { margin: 0; } </style>

    <script src="//unpkg.com/three"></script>
    <script src="//unpkg.com/three/examples/js/controls/TrackballControls.js"></script>
    <script src="//unpkg.com/three-globe"></script>
    <!--<script src="../../dist/three-globe.js"></script>-->
</head>

<body>
    <div id="globeViz"></div>
    <div id="graphic-slider-div">
        <input type="range" min="0" max="113" value="0" step="1" id="graphic-slider" class="slider">
        <p id="slider-text">Year: <span id="slider-num"></span></p>
    </div>

    <script>
        async function getCapitalLocationData() {
            var countriesRes = await fetch('/data/capitals.geojson');
            return countriesRes.json();
        }

        async function getCountryTradeData() {
            var countriesRes = await fetch('/data/countryTrade.json');
            return countriesRes.json();
        }

        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function heatMap(idx) {
            const heatMap = [
                "rgba(0, 255, 255, 0.05)",
                "rgba(0, 191, 255, 0.05)",
                "rgba(0, 127, 255, 0.05)",
                "rgba(0, 63, 255, 0.05)",
                "rgba(0, 0, 255, 0.1)",
                "rgba(0, 0, 223, 0.1)",
                "rgba(0, 0, 191, 0.2)",
                "rgba(0, 0, 159, 0.2)",
                "rgba(0, 0, 127, 0.3)",
                "rgba(63, 0, 91, 0.5)",
                "rgba(127, 0, 63, 0.7)",
                "rgba(191, 0, 31, 1)",
                "rgba(255, 0, 0, 1)"
            ]
            return heatMap[idx];
        }
        
        function setTradeData(idx, tradeData, capitalLocations, globe) {
            arcsData = tradeData[idx].trade_data.map((trade_link) => ({
                startLat: capitalLocations.features[trade_link[0]].geometry.coordinates[1],
                startLng: capitalLocations.features[trade_link[0]].geometry.coordinates[0],
                endLat: capitalLocations.features[trade_link[1]].geometry.coordinates[1],
                endLng: capitalLocations.features[trade_link[1]].geometry.coordinates[0],
                color: heatMap(Math.round(Math.log(trade_link[2]))),
                dashLen: (Math.log(trade_link[2]) + 1) / 320,
                dashGap: (Math.log(trade_link[2]) + 1) / 80,
                animateTime: 160000 / (Math.log(trade_link[2]) + 1)
            }));

            globe
            .arcsData(arcsData)
            .arcColor('color')
            .arcDashLength('dashLen')
            .arcDashGap('dashGap')
            .arcDashAnimateTime('animateTime')
        }

        (async () => {
            const Globe = new ThreeGlobe()
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .arcsTransitionDuration(0)
            .arcAltitudeAutoScale(0.8)

            var year = "";

            var slider = document.getElementById("graphic-slider");
            var output = document.getElementById("slider-num");

            (async () => {
                capitalLocations = await getCapitalLocationData();
                tradeData = await getCountryTradeData();

                output.innerHTML = tradeData[slider.value].year;
                setTradeData(slider.value, tradeData, capitalLocations, Globe);
        
                slider.oninput = function() {
                    output.innerHTML = tradeData[this.value].year;
                }

                slider.onmouseup = function() {
                    setTradeData(this.value, tradeData, capitalLocations, Globe);
                }
            })();

            // Setup renderer
            const renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('globeViz').appendChild(renderer.domElement);

            // Setup scene
            const scene = new THREE.Scene();
            scene.add(Globe);
            scene.add(new THREE.AmbientLight(0xbbbbbb));
            scene.add(new THREE.DirectionalLight(0xffffff, 0.6));

            // Setup camera
            const camera = new THREE.PerspectiveCamera();
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            camera.position.z = 500;

            // Add camera controls
            const tbControls = new THREE.TrackballControls(camera, renderer.domElement);
            tbControls.minDistance = 350;
            tbControls.maxDistance = 350;
            tbControls.rotateSpeed = 5;
            tbControls.noZoom = true;

            // Kick-off renderer
            (function animate() { // IIFE
                // Frame cycle
                tbControls.update();
                renderer.render(scene, camera);
                setTimeout( function() {
                    requestAnimationFrame( animate );
                }, 1000 / 24 );
            })();
        })();
    </script>
</body>